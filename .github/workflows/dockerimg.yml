name: Docker Image CI/CD
on:
  pull_request_target:
    branches:
      - main
      
permissions:
  pull-requests: write
  issues: write

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout código
          uses: actions/checkout@v4
    
        - name: Configurar Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'
    
        - name: Instalar dependencias
          run: |
            pip install -r requirements.txt
    
        - name: Ejecutar pruebas unitarias
          run: pytest --maxfail=1 --disable-warnings -q

    build-and-publish:
        needs: test
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
        steps:
        - name: Checkout código
          uses: actions/checkout@v4

        - name: Configurar Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Iniciar sesión en Docker Hub
          uses: docker/login-action@v3
          with:
            registry: docker.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Construir y publicar imagen Docker
          run: |
            IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/predictor-enfermedades
            docker build -t $IMAGE_NAME:latest .
            docker push $IMAGE_NAME:latest
            echo "The docker image is hosted at ghcr.io/${{ github.repository_owner }}/predictor-enfermedades:latest"
           